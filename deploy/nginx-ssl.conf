# ── RoleRadar — Nginx + Let's Encrypt SSL config ─────────────────────────────
# Prerequisites:
#   sudo apt install certbot python3-certbot-nginx
#   sudo certbot --nginx -d yourdomain.com
#   (certbot will auto-fill the ssl_certificate paths below)
#
# Usage: copy to /etc/nginx/sites-available/roleradar, update server_name,
#        run certbot, then: sudo nginx -t && sudo systemctl reload nginx
# ---------------------------------------------------------------------------

# Redirect HTTP → HTTPS
server {
    listen 80;
    server_name yourdomain.com;                  # ← change this

    location /.well-known/acme-challenge/ {
        root /var/www/html;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS
server {
    listen 443 ssl http2;
    server_name yourdomain.com;                  # ← change this

    # Certbot will fill these in automatically:
    ssl_certificate     /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # Streamlit requires WebSocket support
    location / {
        proxy_pass         http://127.0.0.1:8501;
        proxy_http_version 1.1;

        # WebSocket upgrade
        proxy_set_header   Upgrade    $http_upgrade;
        proxy_set_header   Connection "upgrade";

        # Standard proxy headers
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_read_timeout  300s;
        proxy_send_timeout  300s;
        proxy_connect_timeout 10s;
        proxy_buffering off;
    }

    # Optional: Basic auth to keep the app private
    # Uncomment and run: sudo htpasswd -c /etc/nginx/.htpasswd youruser
    # auth_basic           "RoleRadar";
    # auth_basic_user_file /etc/nginx/.htpasswd;
}
